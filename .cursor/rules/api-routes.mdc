---
description: API route handler patterns â€” auth checks, error responses, and data access
globs: app/api/**/*.ts
alwaysApply: false
---

# API Route Conventions

## Authentication

Every protected endpoint starts with:

```ts
const session = await getSession();
if (!session) return apiError("Not authenticated", 401);
```

- `getSession()` from `@/lib/auth`
- `apiError()` / `apiSuccess()` from `@/lib/api-utils`

## Authorization

For coach-gated group endpoints, use:

```ts
const allowed = await canManageGroup(db, session.id, groupId);
if (!allowed) return apiError("Not authorized", 403);
```

- `canManageGroup()` from `@/lib/api-auth`

## Data Access

- Get a db handle via `const db = await getDb()` from `@/lib/mongodb`
- Validate user-supplied ObjectIds with `safeObjectId()` from `@/lib/objectid`

## Error Shape

Always return `{ error: string }` with an appropriate HTTP status:

```ts
return apiError("Group not found", 404);
```

## Error Handling

Wrap handler bodies in try/catch. Log with `console.error` and return a 500:

```ts
try {
  // ...handler logic
} catch (err) {
  console.error("POST /api/example:", err);
  return apiError("Internal server error", 500);
}
```
